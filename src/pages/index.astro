---
import Layout from "../layouts/Layout.astro";
import ActivitiesPage from "../components/ActivitiesPage.astro";
import { setAstroSession } from "../lib/supabase";
import { loginCheck } from "@/lib/auth";

import GoalList from "../components/GoalList.astro";
import PostSection from "../components/PostSection.astro";

const { cookies, redirect, rewrite } = Astro;

Astro.request.headers.set("Cache-Control", "no-store");

// console.log("accessToken", accessToken, refreshToken, process.env.SITE);

// let hasGoals = false;

const { supabase, data, error } = await setAstroSession(Astro.cookies);
if (error) return Astro.redirect("/api/auth/signout");

// if (data) {
//   if (!data.user?.id) throw new Error("User not found");

//   // if user has uncompleted goals in supabase, redirect to /goals
//   // 24hrs to complete goals
//   const { count, data: d } = await supabase
//     .from("goals")
//     .select("*", { count: "exact", head: false })
//     .eq("uid", data.user?.id)
//     .is("completed", null);
//   // .gte("created_at", new Date(Date.now() - 1000 * 60 * 60 * 24 * 1).toISOString());
//   //.gte("created_at", new Date().toISOString().split("T")[0]);

//   // console.log("count", count, d);

//   if (count && count > 0) {
//     //  console.log("redirecting to /goals");
//     hasGoals = true;
//     // return rewrite("/goals");
//   }

//   // if (data.user?.email) email = data.user?.email;
// }
// return data.user?.email;

const check = loginCheck(Astro);
if (check) return check;

return redirect("/directory");
---

<Layout title="Choose Your Goals" transition:animate="fade">
  <!-- {hasGoals ? (
    <GoalList />
    <PostSection />
  ) : (
     <ActivitiesPage />
  )} -->
</Layout>
