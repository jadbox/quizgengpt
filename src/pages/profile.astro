---
import Layout from "@/layouts/Layout.astro";
import { loginCheck } from "@/lib/auth";
import UserProfile from "@/components/UserProfile.astro";
import { setAstroSession } from "@/lib/supabase";

const { supabase, data } = await setAstroSession(Astro.cookies);

const check = loginCheck(Astro);
if (check) return check;
// server:defer

async function fetchProfile() {
  if (!data?.user?.id) throw new Error("No user ID");
  const { data: goals, error } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", data?.user?.id)
    .single();

  if (error) {
    console.error("Error fetching goals:", error);
    throw new Error("Error fetching goals");
  }
  return goals || [];
}

const profile = await fetchProfile();
if (profile?.username) Astro.cookies.set("name", profile?.username);
---

<Layout title="Profile" transition:animate="fade">
  <UserProfile profile={profile} />
</Layout>
