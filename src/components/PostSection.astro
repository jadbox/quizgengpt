---
import { setAstroSession, Profile, supabaseServer } from "@/lib/supabase";
import EmojiSection from "./EmojiSection.astro";
import ActivitySelector from "./ActivitySelector.astro";
import SocialStatus from "./social/SocialStatus.astro";
// populate comments from supabase message table with content field

const { supabase, user } = await setAstroSession(Astro.cookies);

// newer than 24hrs
const { data } = await supabase
  .from("messages")
  .select("content, profile_id, created_at, id")
  .gte("created_at", new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString())
  .limit(10)
  .order("created_at", { ascending: false });

const uid = user?.user?.id as string;
// get closest 10 users to uid profiles.last_post and using distance from location that's a postgis field
// const { data: userRow } = await supabase
//   .from("profiles")
//   .select(`id, username, last_post, location, status`)
//   .eq("id", uid)
//   .single();

// const userLocation = userRow?.location;

// console.log(userRow?.id.slice(0, 5), "userLocation", "__", userLocation); // 0101000020E6100000C444B9FAA02145401369490F4AEF54C0

// console.log("data", data);
var comments = data || [];

// console.log("comments", comments);

const { cookies, redirect } = Astro;

const name = cookies.get("name")?.value || "";

// Function to detect image URL in the post body
const detectImageUrl = (text: string): string | null => {
  const urlRegex = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp|webm))/i;
  const match = text.match(urlRegex);
  return match ? (match[0] as string) : null;
};

// detect link url intest
const detectLinkUrl = (text: string) => {
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  const match = text.match(urlRegex);
  return match ? match[0] : null;
};

const _comments = comments.map((comment) => {
  const imageUrl = detectImageUrl(comment.content);
  const link = !imageUrl && detectLinkUrl(comment.content);
  if (imageUrl) comment.content = comment.content.replace(imageUrl, "");
  else {
    if (link) {
      comment.content = comment.content.replace(link, "");
    }
  }
  return { imageUrl: imageUrl, link: link, ...comment };
});
---

<RootElement data={{ name, uid }}>
  <div class="flex flex-col items-center justify-center pt-4">
    <h1 class="text-xl font-bold text-black">Weekly Bulletin Board</h1>
    <!-- small label notice that this is sorted by neightest neighbor -->
    <div class="text-sm text-gray-900 mt-1">sorted by nearest neighbor</div>

    <!-- <h1 class="text-xl font-bold text-slate-600">Set your status:</h1>
     <ActivitySelector feelings="true" /> -->

    <SocialStatus uid={uid} } />

    <div class="flex-center flex-col w-full">
      <input
        data-uid={uid}
        type="text"
        placeholder="Request help, announce meetup, post community note..."
        class="w-full md:w-2/3 p-2 mt-2 mb-4 border border-green-400 rounded-lg bg-gray-800 text-gray-200 placeholder-gray-500"
        id="messageInput"
      />
      <button class="black_btn w-1/3 md:h-full md:w-1/5" id="handleSubmitBtn">
        update your post
      </button>
    </div><br />

    <h1 class="text-xl font-bold text-black">Goal News Feed</h1>

    <div
      class="glassmorphism w-full md:w-2/3 space-y-2 bg-gray-900 p-4 rounded-xl mt-5 mb-2 overflow-y-visible"
      id="commentbox"
    >
      {
        _comments.map((comment) => {
          const isUserMessage = comment.profile_id === uid;
          const formattedDate = new Date(comment.created_at).toLocaleString();
          return (
            <div class="flex-center flex-col">
              <p
                class={`${
                  isUserMessage
                    ? "bg-blue-700 text-gray-200 self-end"
                    : "bg-gray-700 text-gray-200 self-start"
                } p-2 rounded-lg max-w-xs break-words`}
              >
                {comment.content}
                {comment.imageUrl && (
                  <a href={comment.imageUrl} target="_blank">
                    <img
                      src={comment.imageUrl}
                      alt="Shared image"
                      class="w-full max-w-32 h-auto object-cover rounded-lg shadow-md mb-2"
                    />
                  </a>
                )}
                {comment.link && (
                  <a
                    href={comment.link}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-blue-400 underline"
                  >
                    {comment.link}
                  </a>
                )}
                <>
                  <br />
                  <span class="text-xs text-gray-200 mt-1">
                    {formattedDate}
                  </span>
                </>
                <EmojiSection id={comment.id} />
              </p>
            </div>
          );
        })
      }
    </div>
  </div>

  <script>
    import "@/scripts/emoji-reactions.js";
  </script>
  <script>
    import { supabase } from "@/lib/supabase";
    import { navigate } from "astro:transitions/client";
    import { getAndSaveLocation } from "@/scripts/getAndSaveLocation";
    import { debounce } from "throttle-debounce";

    const actionReload = debounce(
      3000,
      () => navigate("/", { history: "replace" }),
      {
        atBegin: false,
      }
    );

    RootElement.ready(($, ctx) => {
      function makeComment(comment: string) {
        actionReload();
      }

      const handleInserts = (payload: any) => {
        console.log("payload", payload);
        const newComment = payload.new.content;
        const el = document.getElementById("commentbox");
        makeComment(newComment);
        // if (el) el.innerHTML = +el.innerHTML;
      };

      const handleSubmit = async () => {
        const input = document.getElementById(
          "messageInput"
        ) as HTMLInputElement;

        if (!input.value) {
          alert("Please enter a message");
          return;
        }
        const message = `${input.value}`;

        const uid = input.getAttribute("data-uid")?.toString() as string;
        // console.log("{ content: message, profile_id: uid }", {
        //   content: message,
        //   profile_id: uid,
        // });

        // delete last user status messages older than 24 hours
        await supabase
          .from("messages")
          .delete()
          .eq("profile_id", uid)
          .like("content", "%: %")
          .gt(
            "created_at",
            new Date(Date.now() - 1000 * 60 * 60 * 24 * 1).toISOString()
          );

        const { data, error } = await supabase
          .from("messages")
          .insert([
            { content: `${ctx.data.name}: ${message}`, profile_id: uid },
          ]);

        // update last_post in profiles table
        await supabase
          .from("profiles")
          .update({ last_post: new Date().toISOString(), status: message })
          .match({ id: uid });

        if (error) {
          alert("Error inserting message: " + error.message);
          console.error("Error inserting message:", error);
        } else {
          console.log("Message inserted successfully:", data);
          input.value = "";
          navigate("/", { history: "replace" });
          // makeComment(message);
        }
      };

      // Handle Submit button click
      const submitButton = document.getElementById(
        "handleSubmitBtn"
      ) as HTMLButtonElement;

      if (!submitButton) throw new Error("submitButton for comments not found");

      submitButton.addEventListener("click", handleSubmit);

      const input = document.getElementById("messageInput") as HTMLInputElement;
      if (!input) throw new Error("input not found");

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const input = document.getElementById(
            "messageInput"
          ) as HTMLInputElement;
          const message = input.value;

          if (message) handleSubmit();
        }
      });

      // Subscribe to messages channel
      supabase
        .channel("messages-insert")
        .on(
          "postgres_changes",
          { event: "INSERT", schema: "public", table: "messages" },
          handleInserts
        )
        .subscribe();

      supabase
        .channel("messages-update")
        .on(
          "postgres_changes",
          { event: "UPDATE", schema: "public", table: "messages" },
          handleInserts
        )
        .subscribe();
      // console.log("subscribed to messages channel");

      // Get and save location when the page loads
      getAndSaveLocation(ctx.data.uid, document);
    });
  </script>
</RootElement>
